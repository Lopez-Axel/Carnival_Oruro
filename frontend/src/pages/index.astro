---
// src/pages/index.astro - Integrado con autenticación
import MainLayout from '../layouts/MainLayout.astro';
import LoginModal from '../components/LoginModal.astro';
import { getCurrentUser } from '../lib/supabase';

// Verificar si el usuario ya está autenticado
const currentUser = await getCurrentUser();

// Si ya está autenticado, podríamos redirigir al dashboard (opcional)
// if (currentUser) {
//   return Astro.redirect('/dashboard');
// }
---

<MainLayout>
  <!-- Hero Section -->
  <section class="main-container">
    <img 
      src="/images/Portada.jpg" 
      alt="Diablada - Carnaval de Oruro" 
      class="full-bleed-image"
    />
    <div class="overlay-gradient"></div>

    <div class="relative min-h-screen flex flex-col items-center justify-center px-4 text-center">
      <h1 class="hero-title fade-in">
        <span class="block mt-4">Carnaval de Oruro 2025</span>
      </h1>
      
      <p class="hero-subtitle fade-in">
        Este año el diseño de los trajes y las coreografías superarán todas las expectativas.
      </p>

      <!-- Botones principales con autenticación -->
      <div class="flex flex-col sm:flex-row gap-4 mt-8">
        <a href="/eventos" class="hero-button fade-in">
          Revive
        </a>
        
        {currentUser ? (
          <!-- Usuario ya autenticado -->
          <div class="flex flex-col sm:flex-row gap-4">
            <a href="/dashboard" class="hero-button hero-button-secondary fade-in delay-200">
              Mi Dashboard
            </a>
            <a href="/tickets" class="hero-button hero-button-outline fade-in delay-300">
              Mis Tickets
            </a>
          </div>
        ) : (
          <!-- Usuario no autenticado -->
          <div class="flex flex-col sm:flex-row gap-4">
            <button id="login-btn" class="hero-button hero-button-secondary fade-in delay-200">
              Iniciar Sesión
            </button>
            <a href="/signup" class="hero-button hero-button-outline fade-in delay-300">
              Registrarse
            </a>
          </div>
        )}
      </div>

      {currentUser && (
        <!-- Mensaje de bienvenida para usuarios autenticados -->
        <div class="mt-6 fade-in delay-300">
          <p class="text-white/90 text-lg">
            ¡Bienvenido de vuelta, {currentUser.profile?.full_name || currentUser.user?.email}! 🎭
          </p>
        </div>
      )}
    </div>
  </section>

  <!-- Sección de acceso rápido para usuarios autenticados -->
  {currentUser && (
    <section class="py-12 bg-gradient-to-r from-red-900 to-yellow-900">
      <div class="max-w-7xl mx-auto px-4">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-white mb-4">Acceso Rápido</h2>
          <p class="text-white/80">Gestiona tu experiencia del carnaval</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <!-- Mis Tickets -->
          <a href="/tickets" class="quick-access-card">
            <div class="quick-access-icon">🎫</div>
            <h3 class="quick-access-title">Mis Tickets</h3>
            <p class="quick-access-description">Ver entradas compradas</p>
          </a>

          <!-- Comprar Tickets -->
          <a href="/eventos" class="quick-access-card">
            <div class="quick-access-icon">🛒</div>
            <h3 class="quick-access-title">Comprar Tickets</h3>
            <p class="quick-access-description">Nuevas entradas disponibles</p>
          </a>

          <!-- Mi Perfil -->
          <a href="/profile" class="quick-access-card">
            <div class="quick-access-icon">👤</div>
            <h3 class="quick-access-title">Mi Perfil</h3>
            <p class="quick-access-description">Actualizar información</p>
          </a>

          <!-- Dashboard -->
          <a href="/dashboard" class="quick-access-card">
            <div class="quick-access-icon">📊</div>
            <h3 class="quick-access-title">Dashboard</h3>
            <p class="quick-access-description">Panel principal</p>
          </a>
        </div>
      </div>
    </section>
  )}

  <!-- Sección de Eventos -->
  <section class="py-20">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="section-title">
        Próximos Festivales & Eventos
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Evento 1 -->
        <div class="event-card fade-in">
          <img 
            src="/images/Ejemplo.jpeg" 
            alt="Velada del Carnaval"
          />
          <div class="event-card-overlay"></div>
          <div class="event-card-content">
            <h3 class="event-title">Velada del Carnaval</h3>
            <div class="event-info">
              <div class="event-info-item">
                <svg class="event-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6.75 2.5A.75.75 0 017.5 1.75h9a.75.75 0 010 1.5h-9A.75.75 0 016.75 2.5zM4 5.75A.75.75 0 014.75 5h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 5.75zM4 9.75A.75.75 0 014.75 9h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 9.75zM4 13.75A.75.75 0 014.75 13h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 13.75zM4 17.75A.75.75 0 014.75 17h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 17.75zM4 21.75A.75.75 0 014.75 21h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 21.75z"/>
                </svg>
                <span>10 de Febrero, 2025</span>
              </div>
              <div class="event-info-item">
                <svg class="event-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                <span>Plaza 10 de Febrero - Oruro</span>
              </div>
            </div>
            <div class="event-buttons">
              <a href="/eventos/velada" class="event-button">Info</a>
              {currentUser ? (
                <a href="/boletos/velada" class="event-button event-button-primary">Comprar</a>
              ) : (
                <button class="event-button event-button-primary login-required" data-event="velada">
                  Comprar
                </button>
              )}
            </div>
          </div>
        </div>

        <!-- Evento 2 -->
        <div class="event-card fade-in">
          <img 
            src="/images/Ejemplo.jpeg" 
            alt="Entrada del Carnaval"
          />
          <div class="event-card-overlay"></div>
          <div class="event-card-content">
            <h3 class="event-title">Entrada del Carnaval</h3>
            <div class="event-info">
              <div class="event-info-item">
                <svg class="event-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6.75 2.5A.75.75 0 017.5 1.75h9a.75.75 0 010 1.5h-9A.75.75 0 016.75 2.5zM4 5.75A.75.75 0 014.75 5h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 5.75zM4 9.75A.75.75 0 014.75 9h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 9.75zM4 13.75A.75.75 0 014.75 13h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 13.75zM4 17.75A.75.75 0 014.75 17h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 17.75zM4 21.75A.75.75 0 014.75 21h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 21.75z"/>
                </svg>
                <span>11 de Febrero, 2025</span>
              </div>
              <div class="event-info-item">
                <svg class="event-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                <span>Avenida 6 de Agosto - Oruro</span>
              </div>
            </div>
            <div class="event-buttons">
              <a href="/eventos/entrada" class="event-button">Info</a>
              {currentUser ? (
                <a href="/boletos/entrada" class="event-button event-button-primary">Comprar</a>
              ) : (
                <button class="event-button event-button-primary login-required" data-event="entrada">
                  Comprar
                </button>
              )}
            </div>
          </div>
        </div>

        <!-- Evento 3 -->
        <div class="event-card fade-in">
          <img 
            src="/images/Ejemplo.jpeg" 
            alt="Corso del Carnaval"
          />
          <div class="event-card-overlay"></div>
          <div class="event-card-content">
            <h3 class="event-title">Corso del Carnaval</h3>
            <div class="event-info">
              <div class="event-info-item">
                <svg class="event-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6.75 2.5A.75.75 0 017.5 1.75h9a.75.75 0 010 1.5h-9A.75.75 0 016.75 2.5zM4 5.75A.75.75 0 014.75 5h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 5.75zM4 9.75A.75.75 0 014.75 9h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 9.75zM4 13.75A.75.75 0 014.75 13h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 13.75zM4 17.75A.75.75 0 014.75 17h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 17.75zM4 21.75A.75.75 0 014.75 21h14.5a.75.75 0 010 1.5H4.75A.75.75 0 014 21.75z"/>
                </svg>
                <span>12 de Febrero, 2025</span>
              </div>
              <div class="event-info-item">
                <svg class="event-info-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path fill-rule="evenodd" d="M11.54 22.351l.07.04.028.016a.76.76 0 00.723 0l.028-.015.071-.041a16.975 16.975 0 001.144-.742 19.58 19.58 0 002.683-2.282c1.944-1.99 3.963-4.98 3.963-8.827a8.25 8.25 0 00-16.5 0c0 3.846 2.02 6.837 3.963 8.827a19.58 19.58 0 002.682 2.282 16.975 16.975 0 001.145.742zM12 13.5a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                <span>Avenida Cívica - Oruro</span>
              </div>
            </div>
            <div class="event-buttons">
              <a href="/eventos/corso" class="event-button">Info</a>
              {currentUser ? (
                <a href="/boletos/corso" class="event-button event-button-primary">Comprar</a>
              ) : (
                <button class="event-button event-button-primary login-required" data-event="corso">
                  Comprar
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Login Modal (tu componente existente) -->
  <LoginModal />
</MainLayout>

<script>
  // JavaScript para manejar la autenticación
  document.addEventListener('DOMContentLoaded', function() {
    // Botón principal de login
    const loginBtn = document.getElementById('login-btn');
    if (loginBtn) {
      loginBtn.addEventListener('click', function() {
        // Aquí puedes abrir tu modal o redirigir
        window.location.href = '/signin';
        // O si tienes un modal: openLoginModal();
      });
    }

    // Botones de "Comprar" que requieren login
    const loginRequiredBtns = document.querySelectorAll('.login-required');
    loginRequiredBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const event = this.getAttribute('data-event');
        // Guardar el evento en localStorage para redirigir después del login
        localStorage.setItem('intended_purchase', event);
        
        // Mostrar mensaje y redirigir al login
        alert('Debes iniciar sesión para comprar tickets');
        window.location.href = '/signin';
        
        // O abrir tu modal de login existente
        // openLoginModal();
      });
    });

    // Verificar si hay una compra pendiente después del login
    const intendedPurchase = localStorage.getItem('intended_purchase');
    if (intendedPurchase) {
      localStorage.removeItem('intended_purchase');
      // Redirigir a la compra
      setTimeout(() => {
        window.location.href = `/boletos/${intendedPurchase}`;
      }, 1000);
    }
  });
</script>

<style>
  /* Tus estilos existentes */
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fade-in-up {
    from { opacity: 0; transform: translateY(40px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes gradient {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  .animate-fade-in {
    animation: fade-in 1s ease-out forwards;
  }

  .animate-fade-in-up {
    animation: fade-in-up 1s ease-out forwards;
  }

  .animate-gradient {
    animation: gradient 8s ease infinite;
    background-size: 200% auto;
  }

  .delay-200 {
    animation-delay: 200ms;
  }

  .delay-300 {
    animation-delay: 300ms;
  }

  .from-navy-600 {
    --tw-gradient-from: #1a237e;
  }
  .to-red-600 {
    --tw-gradient-to: #b71c1c;
  }

  /* Nuevos estilos para la integración de autenticación */
  .hero-button-secondary {
    background: linear-gradient(135deg, #1a237e, #3949ab);
    border: 2px solid transparent;
  }

  .hero-button-secondary:hover {
    background: linear-gradient(135deg, #3949ab, #1a237e);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(26, 35, 126, 0.4);
  }

  .hero-button-outline {
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.8);
    color: white;
  }

  .hero-button-outline:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: white;
    transform: translateY(-2px);
  }

  .quick-access-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s ease;
    color: white;
    text-decoration: none;
  }

  .quick-access-card:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
  }

  .quick-access-icon {
    font-size: 2.5rem;
    margin-bottom: 16px;
    display: block;
  }

  .quick-access-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: white;
  }

  .quick-access-description {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.8);
    margin: 0;
  }

  .event-button-primary {
    background: linear-gradient(135deg, #d32f2f, #f57c00);
    color: white;
    border: none;
  }

  .event-button-primary:hover {
    background: linear-gradient(135deg, #f57c00, #d32f2f);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(211, 47, 47, 0.4);
  }

  .login-required {
    cursor: pointer;
    position: relative;
  }

  .login-required::after {
    content: "🔒";
    position: absolute;
    top: -5px;
    right: -5px;
    font-size: 0.75rem;
    opacity: 0.7;
  }
</style>